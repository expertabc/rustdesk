name: Sync on New Upstream Release

on:
  schedule:
    # PrÃ¼fe alle 6 Stunden (sparsamer als tÃ¤glich)
    - cron: '0 */6 * * *'
  
  # Manueller Trigger
  workflow_dispatch:

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Get Latest Upstream Release
        id: upstream
        run: |
          # Hole neueste Release-Version von RustDesk
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/releases/latest | jq -r '. tag_name')
          echo "latest_release=$LATEST_RELEASE" >> $GITHUB_OUTPUT
          echo "Neuestes Upstream Release: $LATEST_RELEASE"
      
      - name: Get Current Fork Release
        id: current
        run: |
          # Hole aktuelle Version im Fork
          git fetch --tags
          CURRENT_RELEASE=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "current_release=$CURRENT_RELEASE" >> $GITHUB_OUTPUT
          echo "Aktuelle Fork Version: $CURRENT_RELEASE"
      
      - name: Check if Update Needed
        id: check
        run: |
          UPSTREAM="${{ steps.upstream.outputs.latest_release }}"
          CURRENT="${{ steps.current.outputs. current_release }}"
          
          if [ "$UPSTREAM" != "$CURRENT" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "âœ… Update verfÃ¼gbar: $CURRENT -> $UPSTREAM"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "âœ¨ Fork ist aktuell ($CURRENT)"
          fi
      
      - name: Configure Git
        if: steps.check.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync with Upstream
        if: steps. check.outputs.needs_update == 'true'
        run: |
          # Upstream hinzufÃ¼gen
          git remote add upstream https://github.com/rustdesk/rustdesk. git || true
          
          # Speziellen Release-Tag fetchen
          git fetch upstream tag ${{ steps.upstream.outputs. latest_release }}
          
          # Merge des Release-Tags
          git merge ${{ steps.upstream.outputs.latest_release }} --no-edit -m "Sync with upstream release ${{ steps.upstream.outputs. latest_release }}"
      
      - name: Push Changes
        if: steps.check.outputs.needs_update == 'true'
        run: |
          git push origin master
          
          # Tag auch im Fork erstellen
          git tag ${{ steps.upstream.outputs.latest_release }} || true
          git push origin ${{ steps.upstream.outputs.latest_release }} || true
      
      - name: Create Summary
        run: |
          echo "## ðŸ”„ Sync Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Upstream Release:** ${{ steps. upstream.outputs.latest_release }}" >> $GITHUB_STEP_SUMMARY
          echo "**Fork Version:** ${{ steps.current.outputs.current_release }}" >> $GITHUB_STEP_SUMMARY
          echo "**Update benÃ¶tigt:** ${{ steps.check.outputs.needs_update }}" >> $GITHUB_STEP_SUMMARYs
