name: Auto-Sync on New RustDesk Release

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no new release'
        required: false
        default: 'false'

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Version Tracking
        run: |
          mkdir -p .github/sync
          if [ !  -f .github/sync/last-version.txt ]; then
            echo "0.0.0" > .github/sync/last-version.txt
          fi
      
      - name: Get Upstream Release Info
        id: upstream
        run: |
          RELEASE_JSON=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/releases/latest)
          VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          PUBLISHED=$(echo "$RELEASE_JSON" | jq -r '.published_at')
          URL=$(echo "$RELEASE_JSON" | jq -r '.html_url')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          
          echo "üì¶ Upstream Release: $VERSION"
          echo "üìÖ Published: $PUBLISHED"
      
      - name: Check Current Version
        id: current
        run: |
          CURRENT=$(cat .github/sync/last-version.txt)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "üìå Current Version: $CURRENT"
      
      - name: Determine Action
        id: action
        run: |
          FORCE="${{ github.event.inputs.force_sync }}"
          UPSTREAM="${{ steps.upstream.outputs.version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          
          if [ "$FORCE" == "true" ] || [ "$UPSTREAM" != "$CURRENT" ]; then
            echo "should_sync=true" >> $GITHUB_OUTPUT
            echo "üîÑ Sync will be performed: $CURRENT -> $UPSTREAM"
          else
            echo "should_sync=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Already up to date: $CURRENT"
          fi
      
      - name: Configure Git
        if: steps.action.outputs.should_sync == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Sync with Upstream Release
        if: steps.action.outputs.should_sync == 'true'
        run: |
          set -e
          VERSION="${{ steps.upstream.outputs.version }}"
          
          echo "üîÑ Starting sync for version: $VERSION"
          
          # Remote Management
          if git remote | grep -q "^upstream$"; then
            echo "‚úì Upstream remote exists, updating URL..."
            git remote set-url upstream https://github.com/rustdesk/rustdesk.git
          else
            echo "‚úì Adding upstream remote..."
            git remote add upstream https://github.com/rustdesk/rustdesk.git
          fi
          
          # Verify remote
          echo "‚úì Verifying upstream remote..."
          git remote -v | grep upstream
          
          # Fetch specific tag with retry logic
          echo "‚úì Fetching tag: $VERSION"
          for i in {1..3}; do
            if git fetch upstream tag "$VERSION" --no-tags --depth=1; then
              echo "‚úì Fetch successful"
              break
            else
              echo "‚ö†Ô∏è Fetch attempt $i failed, retrying..."
              sleep 5
            fi
            if [ $i -eq 3 ]; then
              echo "‚ùå Failed to fetch after 3 attempts"
              exit 1
            fi
          done
          
          # Verify tag exists
          if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "‚ùå Error: Tag $VERSION not found after fetch"
            exit 1
          fi
          
          # Merge
          echo "‚úì Merging upstream release..."
          git merge "$VERSION" --no-edit -m "üîÑ Sync with upstream release $VERSION" --allow-unrelated-histories
          
          # Update version tracker
          echo "‚úì Updating version tracker..."
          echo "$VERSION" > .github/sync/last-version.txt
          git add .github/sync/last-version.txt
          
          # Commit if there are changes
          if git diff --cached --quiet; then
            echo "‚úì No changes to commit for version tracker"
          else
            git commit -m "üìù Update version tracker to $VERSION"
          fi
          
          echo "‚úÖ Sync completed successfully!"
      
      - name: Push Changes
        if: steps.action.outputs.should_sync == 'true'
        run: |
          VERSION="${{ steps.upstream.outputs.version }}"
          
          echo "‚¨ÜÔ∏è Pushing changes to fork..."
          git push origin master
          
          echo "üè∑Ô∏è Creating and pushing tag..."
          git tag -f "$VERSION" -m "Release $VERSION from upstream"
          git push origin "$VERSION" --force
          
          echo "‚úÖ Push completed!"
      
      - name: Create Summary
        if: always()
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          ## üîÑ RustDesk Sync Status
          
          | Info | Value |
          |------|-------|
          | **Upstream Version** | ${{ steps.upstream.outputs.version }} |
          | **Previous Version** | ${{ steps.current.outputs.version }} |
          | **Sync Performed** | ${{ steps.action.outputs.should_sync }} |
          | **Release URL** | ${{ steps.upstream.outputs.url }} |
          | **Published** | ${{ steps.upstream.outputs.published }} |
          EOF
          
          if [ "${{ steps.action.outputs.should_sync }}" == "true" ]; then
            if [ "${{ job.status }}" == "success" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚úÖ **Sync successful!** Build workflow will start automatically." >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ùå **Sync failed!** Check the logs above." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ÑπÔ∏è No update required." >> $GITHUB_STEP_SUMMARY
          fi
