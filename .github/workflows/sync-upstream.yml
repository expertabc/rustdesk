name: Auto-Sync on New RustDesk Release

on:
  schedule:
    # PrÃ¼fe tÃ¤glich um 3 Uhr
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync even if no new release'
        required: false
        default: 'false'

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets. GITHUB_TOKEN }}
      
      - name: Setup Version Tracking
        run: |
          mkdir -p .github/sync
          [ ! -f .github/sync/last-version.txt ] && echo "0. 0.0" > .github/sync/last-version.txt || true
      
      - name: Get Upstream Release Info
        id: upstream
        run: |
          # API Call mit vollstÃ¤ndigen Release-Infos
          RELEASE_JSON=$(curl -s https://api.github.com/repos/rustdesk/rustdesk/releases/latest)
          
          VERSION=$(echo "$RELEASE_JSON" | jq -r '.tag_name')
          PUBLISHED=$(echo "$RELEASE_JSON" | jq -r '.published_at')
          URL=$(echo "$RELEASE_JSON" | jq -r '.html_url')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "published=$PUBLISHED" >> $GITHUB_OUTPUT
          echo "url=$URL" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Upstream Release: $VERSION"
          echo "ðŸ“… VerÃ¶ffentlicht: $PUBLISHED"
      
      - name: Check Current Version
        id: current
        run: |
          CURRENT=$(cat .github/sync/last-version.txt)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Aktuelle Version: $CURRENT"
      
      - name: Determine Action
        id: action
        run: |
          FORCE="${{ github.event.inputs.force_sync }}"
          UPSTREAM="${{ steps.upstream.outputs. version }}"
          CURRENT="${{ steps.current.outputs.version }}"
          
          if [ "$FORCE" == "true" ] || [ "$UPSTREAM" != "$CURRENT" ]; then
            echo "should_sync=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Sync wird durchgefÃ¼hrt"
          else
            echo "should_sync=false" >> $GITHUB_OUTPUT
            echo "âœ… Bereits aktuell"
          fi
      
      - name: Configure Git
        if: steps.action.outputs.should_sync == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Sync with Upstream Release
        if: steps.action. outputs.should_sync == 'true'
        run: |
          VERSION="${{ steps.upstream.outputs. version }}"
          
          # Upstream remote hinzufÃ¼gen
          git remote add upstream https://github.com/rustdesk/rustdesk. git || true
          
          # Release-Tag fetchen
          git fetch upstream tag "$VERSION" --no-tags
          
          # Merge
          git merge "$VERSION" --no-edit -m "ðŸ”„ Sync with upstream release $VERSION"
          
          # Version tracken
          echo "$VERSION" > .github/sync/last-version.txt
          git add .github/sync/last-version.txt
          git commit --amend --no-edit
      
      - name: Push Changes
        if: steps.action.outputs.should_sync == 'true'
        run: |
          VERSION="${{ steps.upstream.outputs. version }}"
          
          # Push zu Fork
          git push origin master
          
          # Tag erstellen und pushen
          git tag "$VERSION" -m "Release $VERSION from upstream"
          git push origin "$VERSION"
      
      - name: Create Summary
        if: always()
        run: |
          cat << EOF >> $GITHUB_STEP_SUMMARY
          ## ðŸ”„ RustDesk Sync Status
          
          | Info | Wert |
          |------|------|
          | **Upstream Version** | ${{ steps.upstream. outputs.version }} |
          | **Vorherige Version** | ${{ steps.current.outputs.version }} |
          | **Sync durchgefÃ¼hrt** | ${{ steps.action.outputs.should_sync }} |
          | **Release URL** | ${{ steps.upstream. outputs.url }} |
          | **VerÃ¶ffentlicht** | ${{ steps.upstream.outputs.published }} |
          
          EOF
          
          if [ "${{ steps.action.outputs.should_sync }}" == "true" ]; then
            echo "âœ… **Sync erfolgreich! ** Build-Workflow wird automatisch gestartet." >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Kein Update erforderlich." >> $GITHUB_STEP_SUMMARY
          fi
